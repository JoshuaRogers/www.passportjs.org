<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">
  <head>
    <title>Email Magic Link Tutorial</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="canonical" href="https://www.passportjs.org/tutorials/email/downloads/html/">
    <link rel="manifest" href="/manifest.webmanifest"/>
    <meta name="theme-color" content="#35DF79"/>
    <link rel="shortcut icon" href="/images/favicon/favicon.ico"/>
    <link rel="icon" sizes="16x16" type="image/png" href="/images/favicon/favicon-16x16.png"/>
    <link rel="icon" sizes="32x32" type="image/png" href="/images/favicon/favicon-32x32.png"/>
    <link rel="icon" sizes="36x36" type="image/png" href="/images/favicon/android-icon-36x36.png"/>
    <link rel="icon" sizes="48x48" type="image/png" href="/images/favicon/android-icon-48x48.png"/>
    <link rel="icon" sizes="70x70" type="image/png" href="/images/favicon/ms-icon-70x70.png"/>
    <link rel="icon" sizes="72x72" type="image/png" href="/images/favicon/android-icon-72x72.png"/>
    <link rel="icon" sizes="96x96" type="image/png" href="/images/favicon/android-icon-96x96.png"/>
    <link rel="icon" sizes="144x144" type="image/png" href="/images/favicon/ms-icon-144x144.png"/>
    <link rel="icon" sizes="150x150" type="image/png" href="/images/favicon/ms-icon-150x150.png"/>
    <link rel="icon" sizes="192x192" type="image/png" href="/images/favicon/android-icon-192x192.png"/>
    <link rel="icon" sizes="310x310" type="image/png" href="/images/favicon/ms-icon-310x310.png"/>
    <link rel="apple-touch-icon" href="/images/favicon/apple-icon-57x57.png"/>
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png"/>
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png"/>
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png"/>
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png"/>
    <meta name="msapplication-config" content="/browserconfig.xml"/>
    <meta name="msapplication-TileColor" content="#35DF79"/>
    <meta name="msapplication-TileImage" content="/images/favicon/ms-icon-144x144.png"/>
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="Email Magic Link Tutorial"/>
    <meta property="og:url" content="https://www.passportjs.org/tutorials/email/downloads/html/"/>
    <meta property="og:image" content="https://www.passportjs.org/images/facebook-card.png"/>
    <meta property="og:image:type" content="image/png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <meta property="og:site_name" content="Passport.js"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="@passportjs"/>
    <meta name="twitter:title" content="Email Magic Link Tutorial"/>
    <meta name="twitter:image" content="https://www.passportjs.org/images/twitter-card.png"/>
    <meta name="flattr:id" content="d5znvd"/>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-73332146-2', 'auto');
      ga('send', 'pageview');
    </script>
    <!--+google-tag-manager('GTM-M5S3PH')-->
    <!--link(type='text/css', rel='stylesheet', href='http://fast.fonts.net/cssapi/7527d73a-ebfe-45db-a201-ff2812df4b18.css')-->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css">
    <link rel="stylesheet" href="/assets/styles/all.css">
    <script data-main="/script/main" src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.js"></script>
  </head>
  <body>
    <div id="container"><span id="top"></span>
      <div id="toolbar">
        <div class="toolbar-search">
          <form action="/search">
            <button type="submit"></button>
            <input type="text" name="q" placeholder="Search for Strategies">
          </form>
        </div>
        <div class="toolbar-social">
          <ul>
            <li class="facebook"><a href="https://www.facebook.com/passportjs" target="_blank"></a></li>
            <li class="twitter"><a href="https://twitter.com/passportjs" target="_blank"></a></li>
            <li class="github"><a href="https://github.com/jaredhanson/passport" target="_blank"><span class="count">0</span></a></li>
          </ul>
        </div>
      </div>
      <nav id="menu"><a class="menu-logo" href="/" title="Passport.js"></a>
        <div class="menu-trigger"><span></span></div>
        <div class="menu-items">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/docs/">Documentation</a></li>
            <li><a href="/features/">Features</a></li>
            <li><a href="/packages/">Strategies</a></li>
          </ul><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=passportjsorg" id="_carbonads_js"></script>
        </div>
      </nav>
      <div id="content">
        <div class="book" id="book">
          <div class="toc">
            <nav data-accordion-group="">
              <div class="accordion" data-accordion="">
                <h5 data-control=""><i class="icon-budicon-461"></i><a href="/tutorials/email/"></a></h5>
                <ul data-content="">
                  <li><a href="/tutorials/email/">Introduction</a></li>
                  <li><a href="/tutorials/email/prompt/">Login Prompt</a></li>
                  <li><a href="/tutorials/email/setup/">Set Up SendGrid</a></li>
                  <li><a href="/tutorials/email/configure/">Configure Strategy</a></li>
                  <li><a href="/tutorials/email/send/">Send Email</a></li>
                  <li><a href="/tutorials/email/verify/">Verify Email</a></li>
                  <li><a href="/tutorials/email/session/">Establish Session</a></li>
                  <li><a href="/tutorials/email/logout/">Log Out</a></li>
                </ul>
              </div>
            </nav>
          </div><a id="go-top" href="#top"><i class="icon-budicon-462"></i></a>
          <div class="contents"><section class="chapter" id="README"><h1 id="introduction">Introduction</h1>
<p>We will build a todo list app in this tutorial, complete with functionality that
allows users to sign in with email.  By following along with this tutorial, you
will learn how to use Passport for authentication.</p>
<p>If you want to see where we are headed, here&#39;s an example of the final result:
<a href="https://github.com/passport/todos-express-email">https://github.com/passport/todos-express-email</a></p>
<p>Before we dive in, you&#39;ll need a working development environment with <a href="https://nodejs.org/">Node.js</a>
and <a href="https://git-scm.com/">Git</a>, as well as an editor and terminal of your
choosing.  Take a moment to set up these tools if you have not already done so.</p>
<p>You&#39;ll also need a <a href="https://sendgrid.com/">SendGrid</a> account.  If you don&#39;t
already have one, sign up now.  This tutorial can be completed using SendGrid&#39;s
free plan.</p>
<p>Let&#39;s get started!</p>
<p>We are going to start with a starter app, which has all the scaffolding needed
to build a todo list.  Let&#39;s clone the app:</p>
<pre><code class="lang-sh">$ git <span class="built_in">clone</span> https://github.com/passport/todos-express-starter.git email-tutorial
</code></pre>
<p>You now have a directory named <code>&#39;email-tutorial&#39;</code>.  Let&#39;s <code>cd</code> into it:</p>
<pre><code class="lang-sh">$ <span class="built_in">cd</span> email-tutorial
</code></pre>
<p>Take a moment browse through the files in the starter app.  As we work through
this tutorial, we&#39;ll be using <a href="https://expressjs.com/">Express</a> as our web
framework, along with <a href="https://ejs.co/">EJS</a> as our template engine and <a href="https://developer.mozilla.org/en-US/docs/Web/CSS">CSS</a>
for styling.  We will use <a href="https://github.com/mapbox/node-sqlite3">SQLite</a> as
our database for storing data.  Don&#39;t worry if you are not familiar with these
technologies -- the necessary code will be provided at each step.</p>
<p>Now, let&#39;s install the dependencies:</p>
<pre><code class="lang-sh">$ npm install
</code></pre>
<p>And start the server:</p>
<pre><code>$ <span class="built_in">npm</span> start
</code></pre><p>Let&#39;s check to see if its working.  Open <a href="http://localhost:3000">http://localhost:3000</a>
in your browser.  You should be greeted with a page explaining how todos help
you get things done.</p>
<p>Next, we will <a href="prompt/">add a login page</a> to the app.</p>
</section><section class="chapter" id="prompt"><h1 id="login-prompt">Login Prompt</h1>
<p>We want to let users sign in with email.  For that, we need a login page that
prompts the user to enter their address.  Let&#39;s add that now.</p>
<p>Let&#39;s create a file that will contain authentication-related routes:</p>
<pre><code class="lang-sh">$ touch routes/auth.js
</code></pre>
<p>Add the following code to that file, which creates a login route that will
render the login page.</p>
<pre><code class="lang-js"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);

<span class="keyword">var</span> router = express.Router();

router.get(<span class="string">'/login'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>{
  res.render(<span class="string">'login'</span>);
});

<span class="built_in">module</span>.exports = router;
</code></pre>
<p>Next, we need to add this route to the app.  Open <code>&#39;app.js&#39;</code> and <code>require</code> the
newly created auth routes at line 10, below where <code>&#39;routes/index&#39;</code> is
<code>require</code>&#39;d:</p>
<pre><code class="lang-js"><span class="keyword">var</span> indexRouter = <span class="built_in">require</span>(<span class="string">'./routes/index'</span>);
<span class="keyword">var</span> authRouter = <span class="built_in">require</span>(<span class="string">'./routes/auth'</span>);
</code></pre>
<p>Continuing within <code>&#39;app.js&#39;</code>, use the newly <code>require</code>&#39;d <code>authRouter</code> at line 27,
below where <code>indexRouter</code> is <code>use</code>&#39;d.</p>
<pre><code class="lang-js">app.use(<span class="string">'/'</span>, indexRouter);
app.use(<span class="string">'/'</span>, authRouter);
</code></pre>
<p>The login page has been added to our app!  Let&#39;s see how it looks.</p>
<p>Start the server:</p>
<pre><code class="lang-sh">$ npm start
</code></pre>
<p>And open <a href="http://localhost:3000">http://localhost:3000</a> and click &quot;Sign in.&quot;  We
are prompted to sign in, but there&#39;s no place to enter an email address.</p>
<p>For that we need an HTML form.  Let&#39;s add that now.</p>
<p>Open <code>&#39;views/login.ejs&#39;</code> and add the form at line 15, below the &quot;Sign in&quot;
heading:</p>
<pre><code class="lang-html"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Sign in<span class="tag">&lt;/<span class="name">h1</span>&gt;</span>
<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/login/email"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span>
    <span class="tag">&lt;<span class="name">section</span>&gt;</span>
        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"email"</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">label</span>&gt;</span>
        <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"email"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">autocomplete</span>=<span class="string">"username"</span> <span class="attr">required</span> <span class="attr">autofocus</span>&gt;</span>
    <span class="tag">&lt;/<span class="name">section</span>&gt;</span>
    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Sign in with Email<span class="tag">&lt;/<span class="name">button</span>&gt;</span>
<span class="tag">&lt;/<span class="name">form</span>&gt;</span>
</code></pre>
<p>Refresh the page.  We&#39;ve now got a login page that prompts the user to sign in
with email.  Next, we will <a href="../setup/">set up SendGrid</a>, in preparation for
sending the user a magic link.</p>
</section><section class="chapter" id="setup"><h1 id="set-up-sendgrid">Set Up SendGrid</h1>
<p>Before we can let users sign in to our app with email, we need a way to send
emails.</p>
<p>For that, we are going to use <a href="https://sendgrid.com/">SendGrid</a>.</p>
<p>Go to the <a href="https://app.sendgrid.com">SendGrid dashboard</a>.</p>
<p>Navigate to <strong>Settings &gt; <a href="https://app.sendgrid.com/settings/api_keys">API Keys</a></strong>.</p>
<p>Click <strong>Create API Key</strong>.</p>
<p>Enter <code>&quot;email-tutorial&quot;</code> for the <strong>API Key Name</strong>.</p>
<p>Under <strong>API Key Permissions</strong> select <strong>Restricted Access</strong>.  Then, under
<strong>Access Details</strong>, ensure that <strong>Mail Send &gt; Mail Send</strong> is granted full
access.</p>
<p>Click the <strong>Create &amp; View</strong> button.</p>
<p>The following screen will display your API key.  Save it someplace safe, as we
will use it later.</p>
<p>Next, navigate to <strong>Settings &gt; <a href="https://app.sendgrid.com/settings/sender_auth">Sender Authentication</a></strong>.</p>
<p>If you&#39;ve already verified your domain or email address, it will be displayed
here.  If not, click <strong>Get Started</strong> under <strong>Verify an Address</strong> and complete
<a href="https://docs.sendgrid.com/ui/sending-email/sender-verification">single sender verification</a>.</p>
<p>Now that we have an API key and a verified email address, let&#39;s create a
<code>&#39;.env&#39;</code> file to store them.</p>
<pre><code class="lang-sh">$ touch .env
</code></pre>
<p>Add your email and API key.  The contents of the file should look something like
this:</p>
<pre><code class="lang-sh">EMAIL=user@example.com
SENDGRID_API_KEY=__INSERT_API_KEY_HERE__
</code></pre>
<p>Next we will <a href="../configure/">configure the strategy</a>.</p>
</section><section class="chapter" id="configure"><h1 id="configure-strategy">Configure Strategy</h1>
<p>Now that we&#39;ve set up SendGrid, we are ready to configure Passport and the
<code>passport-magic-link</code> strategy.</p>
<p>Install the necessary dependencies:</p>
<pre><code class="lang-sh">$ npm install passport
$ npm install passport-magic-link
$ npm install @sendgrid/mail
</code></pre>
<p>Open <code>&#39;routes/auth.js&#39;</code> and <code>require</code> the newly installed packages at line 2,
below where <code>express</code> is <code>require</code>&#39;d:</p>
<pre><code class="lang-js"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);
<span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>);
<span class="keyword">var</span> MagicLinkStrategy = <span class="built_in">require</span>(<span class="string">'passport-magic-link'</span>).Strategy;
<span class="keyword">var</span> sendgrid = <span class="built_in">require</span>(<span class="string">'@sendgrid/mail'</span>);
<span class="keyword">var</span> db = <span class="built_in">require</span>(<span class="string">'../db'</span>);
</code></pre>
<p>The app&#39;s database is also <code>require</code>&#39;d.</p>
<p>Add the following code at line 7 to configure the <code>MagicLinkStrategy</code>.</p>
<pre><code>sendgrid.setApiKey(process.env[<span class="string">'SENDGRID_API_KEY'</span>]);

passport.use(<span class="keyword">new</span> MagicLinkStrategy({
  <span class="attr">secret</span>: <span class="string">'keyboard cat'</span>,
  <span class="attr">userFields</span>: [ <span class="string">'email'</span> ],
  <span class="attr">tokenField</span>: <span class="string">'token'</span>,
  <span class="attr">verifyUserAfterToken</span>: <span class="literal">true</span>
}, <span class="function"><span class="keyword">function</span> <span class="title">send</span>(<span class="params">user, token</span>) </span>{
  <span class="keyword">var</span> link = <span class="string">'http://localhost:3000/login/email/verify?token='</span> + token;
  <span class="keyword">var</span> msg = {
    <span class="attr">to</span>: user.email,
    <span class="attr">from</span>: process.env[<span class="string">'EMAIL'</span>],
    <span class="attr">subject</span>: <span class="string">'Sign in to Todos'</span>,
    <span class="attr">text</span>: <span class="string">'Hello! Click the link below to finish signing in to Todos.\r\n\r\n'</span> + link,
    <span class="attr">html</span>: <span class="string">'&lt;h3&gt;Hello!&lt;/h3&gt;&lt;p&gt;Click the link below to finish signing in to Todos.&lt;/p&gt;&lt;p&gt;&lt;a href="'</span> + link + <span class="string">'"&gt;Sign in&lt;/a&gt;&lt;/p&gt;'</span>,
  };
  <span class="keyword">return</span> sendgrid.send(msg);
}, <span class="function"><span class="keyword">function</span> <span class="title">verify</span>(<span class="params">user</span>) </span>{
  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>) </span>{
    db.get(<span class="string">'SELECT * FROM users WHERE email = ?'</span>, [
      user.email
    ], <span class="function"><span class="keyword">function</span>(<span class="params">err, row</span>) </span>{
      <span class="keyword">if</span> (err) { <span class="keyword">return</span> reject(err); }
      <span class="keyword">if</span> (!row) {
        db.run(<span class="string">'INSERT INTO users (email, email_verified) VALUES (?, ?)'</span>, [
          user.email,
          <span class="number">1</span>
        ], <span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>{
          <span class="keyword">if</span> (err) { <span class="keyword">return</span> reject(err); }
          <span class="keyword">var</span> id = <span class="keyword">this</span>.lastID;
          <span class="keyword">var</span> obj = {
            <span class="attr">id</span>: id,
            <span class="attr">email</span>: user.email
          };
          <span class="keyword">return</span> resolve(obj);
        });
      } <span class="keyword">else</span> {
        <span class="keyword">return</span> resolve(row);
      }
    });
  });
}));
</code></pre><p>This configures the <code>MagicLinkStrategy</code> to send emails containing a magic link
using SendGrid.  When the user clicks on the magic link, the user record
associated with the email address will be found.  If a user record does not
exist, one is created the first time someone signs in.</p>
<p>The strategy is now configured.  Next we need to <a href="../send/">send the user a magic link</a>
when they click &quot;Sign in with Email.&quot;</p>
</section><section class="chapter" id="send"><h1 id="send-email">Send Email</h1>
<p>Now that we are prompting the user for their email address, and have the
strategy configured, the next step is to send the user an email when they click
&quot;Sign in with Email.&quot;</p>
<p>Open <code>&#39;routes/auth.js&#39;</code>, add this route at line 56, below the <code>&#39;/login&#39;</code> route:</p>
<pre><code class="lang-js">router.post(<span class="string">'/login/email'</span>, passport.authenticate(<span class="string">'magiclink'</span>, {
  <span class="attr">action</span>: <span class="string">'requestToken'</span>,
  <span class="attr">failureRedirect</span>: <span class="string">'/login'</span>
}), <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>{
  res.redirect(<span class="string">'/login/email/check'</span>);
});
</code></pre>
<p>This route will process the form on the login page and send an email to the
user.</p>
<p>Continuing within <code>&#39;routes/auth.js&#39;</code>, add this route at line 63, below the newly
added <code>&#39;/login/email&#39;</code> route:</p>
<pre><code class="lang-js">router.get(<span class="string">'/login/email/check'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>{
  res.render(<span class="string">'login/email/check'</span>);
});
</code></pre>
<p>This route will render a page instructing the user to check their email and
click the link.</p>
<p>Next, we will <a href="../verify/">verify the email</a> when the user clicks that link.</p>
</section><section class="chapter" id="verify"><h1 id="verify-email">Verify Email</h1>
<p>Now that we&#39;ve sent the user an email with a magic link, the next step is to
verify the email address when they click the link.</p>
<p>Open <code>&#39;routes/auth.js&#39;</code>, add this route at line 67, below the <code>&#39;/login/email/check&#39;</code>
route:</p>
<pre><code class="lang-js">router.get(<span class="string">'/login/email/verify'</span>, passport.authenticate(<span class="string">'magiclink'</span>, {
  <span class="attr">successReturnToOrRedirect</span>: <span class="string">'/'</span>,
  <span class="attr">failureRedirect</span>: <span class="string">'/login'</span>
}));
</code></pre>
<p>This route will verify the email address when the link is clicked.</p>
<p>Let&#39;s test it out to see what happens.</p>
<p>Start the server:</p>
<pre><code class="lang-sh">$ npm start
</code></pre>
<p>Open <a href="http://localhost:3000">http://localhost:3000</a>, click &quot;Sign in&quot;, enter your
email address and click &quot;Sign in with Email&quot;.</p>
<p>Now, check your email and click the link.</p>
<p>Uh oh... we are informed that there&#39;s an error related to sessions.  Next, we
will fix that by <a href="../session/">establishing a session</a>.</p>
</section><section class="chapter" id="session"><h1 id="establish-session">Establish Session</h1>
<p>Once we&#39;ve verified the user&#39;s email address, we need to a login session to
remember the fact that the user has authenticated as they navigate the app.</p>
<p>To do that, we&#39;ll add session support.  Begin by installing the necessary
dependencies:</p>
<pre><code class="lang-sh">$ npm install express-session
$ npm install connect-sqlite3
</code></pre>
<p>Open <code>&#39;app.js&#39;</code> and <code>require</code> the additional dependencies at line 8, below
where <code>&#39;morgan&#39;</code> is <code>require</code>&#39;d:</p>
<pre><code class="lang-js"><span class="keyword">var</span> logger = <span class="built_in">require</span>(<span class="string">'morgan'</span>);
<span class="keyword">var</span> passport = <span class="built_in">require</span>(<span class="string">'passport'</span>);
<span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">'express-session'</span>);

<span class="keyword">var</span> SQLiteStore = <span class="built_in">require</span>(<span class="string">'connect-sqlite3'</span>)(session);
</code></pre>
<p>Add the following code at line 29, after <code>express.static</code> middleware, to
maintain and authenticate the session.</p>
<pre><code class="lang-js">app.use(express.static(path.join(__dirname, <span class="string">'public'</span>)));
app.use(session({
  <span class="attr">secret</span>: <span class="string">'keyboard cat'</span>,
  <span class="attr">resave</span>: <span class="literal">false</span>,
  <span class="attr">saveUninitialized</span>: <span class="literal">false</span>,
  <span class="attr">store</span>: <span class="keyword">new</span> SQLiteStore({ <span class="attr">db</span>: <span class="string">'sessions.db'</span>, <span class="attr">dir</span>: <span class="string">'./var/db'</span> })
}));
app.use(passport.authenticate(<span class="string">'session'</span>));
</code></pre>
<p>Finally, we need to configure Passport to manage the login session.  Open
<code>&#39;routes/auth.js&#39;</code> and add the following code at line 50:</p>
<pre><code class="lang-js">passport.serializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, cb</span>) </span>{
  process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    cb(<span class="literal">null</span>, { <span class="attr">id</span>: user.id, <span class="attr">email</span>: user.email });
  });
});

passport.deserializeUser(<span class="function"><span class="keyword">function</span>(<span class="params">user, cb</span>) </span>{
  process.nextTick(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>{
    <span class="keyword">return</span> cb(<span class="literal">null</span>, user);
  });
});
</code></pre>
<p>Now, let&#39;s retry signing in.  Open <a href="http://localhost:3000">http://localhost:3000</a>,
click &quot;Sign in&quot;, enter your email address and click &quot;Sign in with Email&quot;.</p>
<p>Now, check your email and click the link.</p>
<p>We are logged in!  Go ahead and enter some tasks you&#39;ve been needing to get
done.</p>
<p>At this point, users can sign in with email!  Next, we will add the ability to
<a href="../logout/">sign out</a>.</p>
</section><section class="chapter" id="logout"><h1 id="log-out">Log Out</h1>
<p>Now that users can sign in, they&#39;ll need a way to sign out.</p>
<p>Open <code>&#39;routes/auth.js&#39;</code> and add this route at line 84, below the
<code>&#39;/login/email/verify&#39;</code> route:</p>
<pre><code class="lang-js">router.post(<span class="string">'/logout'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>{
  req.logout();
  res.redirect(<span class="string">'/'</span>);
});
</code></pre>
<p>Return to the app, where you should already be signed in, and click &quot;Sign out.&quot;</p>
<p>We&#39;ve now got a working app where users can sign in and sign out!</p>
</section></div>
        </div>
      </div>
    </div>
    <div class="search-con">
      <div class="head"><span class="close-ico"></span>
        <div class="hold">
          <h2>SEARCH FOR STRATEGIES</h2>
          <form action="/">
            <input value="" type="text" name="strategy" placeholder="Start typing" autocomplete="off">
          </form>
          <p class="info-line"><span>0</span>STRATEGIES</p>
        </div>
      </div>
      <div class="results">
        <section></section>
      </div>
    </div>
    <!--+google-tag-manager-noscript('GTM-M5S3PH')-->
  </body>
</html>